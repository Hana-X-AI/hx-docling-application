# Claude Code Instructions: hx-docling-ui Phase 1

**Project**: hx-docling-ui  
**Phase**: 1 - Development  
**Target Server**: hx-cc-server (192.168.10.224)  
**Charter Reference**: hx-docling-ui-charter-v0.5.0.md  
**Version**: 2.0

---

## CRITICAL CONTEXT

You are building a Next.js 16 web application for document processing. This is **Phase 1: Development only**. The application will run on hx-cc-server using native Node.js - NO Docker.

This application includes **persistent storage** for processing history and results.

---

## DO ✅

### Environment
- ✅ DO develop on hx-cc-server (192.168.10.224)
- ✅ DO use Node.js 20.x (native installation)
- ✅ DO use `npm run dev` for development server
- ✅ DO create project at `/home/agent0/hx-docling-ui/`
- ✅ DO use port 3000 for development
- ✅ DO use `/tmp/docling-processing/` for temporary file uploads (before persistence)

### Technology Stack
- ✅ DO use Next.js 16.x with App Router
- ✅ DO use TypeScript >= 5.1.0
- ✅ DO use shadcn/ui components (reference: hx-shadcn-server)
- ✅ DO use Zustand 5.x for client state management
- ✅ DO use Zod for validation
- ✅ DO use Tailwind CSS for styling
- ✅ DO use Prisma for database ORM (hx-postgres-server)
- ✅ DO use ioredis for Redis client (hx-redis-server)

### Persistent Storage (NEW)
- ✅ DO connect to hx-postgres-server (192.168.10.208) for:
  - Processing results (Markdown, HTML, JSON output)
  - Job history and metadata (status, timestamps, file info)
- ✅ DO connect to hx-redis-server (192.168.10.209) for:
  - User session tracking
- ✅ DO store uploaded files persistently at `/data/docling-uploads/` on hx-cc-server
- ✅ DO implement data retention policy (define in schema)
- ✅ DO create Prisma schema for jobs and results tables

### MCP Integration
- ✅ DO connect to hx-docling-mcp-server at `http://hx-docling-mcp-server.hx.dev.local:8000/mcp`
- ✅ DO implement these **8 MCP tools** (Phase 1):

| Tool | File Types | Category |
|------|------------|----------|
| `convert_pdf` | .pdf | Conversion |
| `convert_docx` | .docx | Conversion |
| `convert_xlsx` | .xls, .xlsx | Conversion |
| `convert_pptx` | .ppt, .pptx | Conversion |
| `convert_url` | URLs | Conversion |
| `export_markdown` | - | Export |
| `export_html` | - | Export |
| `export_json` | - | Export |

- ✅ DO use SSE for progress streaming
- ✅ DO implement the error catalog (ErrorCode E001-E999)

### Quality
- ✅ DO ensure TypeScript compiles with zero errors
- ✅ DO ensure ESLint passes
- ✅ DO write unit tests (Vitest)
- ✅ DO test against the real MCP server for integration tests
- ✅ DO verify `npm run build` succeeds before completing

### File Structure
- ✅ DO follow the directory structure in the charter (Section 6.4)
- ✅ DO create API routes at `/api/upload`, `/api/process`, `/api/health`, `/api/history`
- ✅ DO organize components by feature (upload/, processing/, results/, history/)
- ✅ DO create `prisma/schema.prisma` for database schema

---

## DO NOT ❌

### Docker - ABSOLUTELY PROHIBITED IN PHASE 1
- ❌ DO NOT create a Dockerfile
- ❌ DO NOT create docker-compose.yml
- ❌ DO NOT reference Docker in any configuration
- ❌ DO NOT containerize the application
- ❌ DO NOT mention Docker in README or documentation
- ❌ DO NOT deploy to hx-dev-server (that's Phase 2)

### Scope Boundaries
- ❌ DO NOT implement user authentication (session tracking is anonymous)
- ❌ DO NOT implement the 13 backlog MCP tools (see Backlog section)
- ❌ DO NOT add features not in the charter

### Technology
- ❌ DO NOT use Redux (use Zustand instead)
- ❌ DO NOT use Pages Router (use App Router)
- ❌ DO NOT use external CDNs or third-party services
- ❌ DO NOT add dependencies not specified in the charter

### Development
- ❌ DO NOT develop on any server other than hx-cc-server
- ❌ DO NOT skip the integration checkpoint after Sprint 1.4
- ❌ DO NOT proceed without MCP server health check passing
- ❌ DO NOT commit .env files with secrets

---

## ENVIRONMENT CONFIGURATION

### .env.development (create this file)
```env
NODE_ENV=development

# MCP Server
DOCLING_MCP_URL=http://hx-docling-mcp-server.hx.dev.local:8000/mcp
DOCLING_MCP_TIMEOUT=300000

# File Upload
MAX_FILE_SIZE_MB=100
ALLOWED_FILE_TYPES=.pdf,.docx,.doc,.pptx,.ppt,.xlsx,.xls,.png,.jpg,.jpeg,.tiff
TEMP_STORAGE_PATH=/tmp/docling-processing
PERSISTENT_STORAGE_PATH=/data/docling-uploads

# PostgreSQL (hx-postgres-server)
DATABASE_URL=postgresql://docling_user:${DB_PASSWORD}@hx-postgres-server.hx.dev.local:5432/docling_db

# Redis (hx-redis-server)
REDIS_URL=redis://hx-redis-server.hx.dev.local:6379/0

# Application
NEXT_PUBLIC_APP_VERSION=1.0.0-dev
```

---

## DATABASE SCHEMA (Prisma)

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Job {
  id          String   @id @default(uuid())
  sessionId   String   // Anonymous session from Redis
  status      JobStatus
  inputType   InputType
  fileName    String?
  fileSize    Int?
  filePath    String?  // Persistent storage path
  url         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  error       String?
  errorCode   String?
  
  results     Result[]
  
  @@index([sessionId])
  @@index([createdAt])
}

model Result {
  id        String     @id @default(uuid())
  jobId     String
  job       Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  format    ResultFormat
  content   String     @db.Text
  size      Int
  createdAt DateTime   @default(now())
  
  @@index([jobId])
}

enum JobStatus {
  PENDING
  UPLOADING
  PROCESSING
  COMPLETE
  ERROR
}

enum InputType {
  FILE
  URL
}

enum ResultFormat {
  MARKDOWN
  HTML
  JSON
  RAW
}
```

---

## SUPPORTED FILE TYPES (Phase 1)

| Format | Extensions | Max Size | MCP Tool |
|--------|------------|----------|----------|
| PDF | .pdf | 100 MB | `convert_pdf` |
| Word | .doc, .docx | 50 MB | `convert_docx` |
| Excel | .xls, .xlsx | 50 MB | `convert_xlsx` |
| PowerPoint | .ppt, .pptx | 50 MB | `convert_pptx` |
| Images | .png, .jpg, .jpeg, .tiff | 25 MB | `convert_pdf` (image mode) |
| Web Pages | http://, https:// | N/A | `convert_url` |

---

## BACKLOG (DO NOT IMPLEMENT IN PHASE 1)

These 13 MCP tools are documented for future phases:

| Tool | Description | Future Phase |
|------|-------------|--------------|
| `generate_title` | Auto-generate document title | Backlog |
| `generate_toc` | Generate table of contents | Backlog |
| `generate_sections` | Extract document sections | Backlog |
| `generate_headings` | Extract heading hierarchy | Backlog |
| `generate_paragraphs` | Extract paragraphs | Backlog |
| `generate_lists` | Extract lists | Backlog |
| `generate_tables` | Extract tables | Backlog |
| `generate_images` | Extract images | Backlog |
| `generate_code_blocks` | Extract code blocks | Backlog |
| `generate_references` | Extract references | Backlog |
| `generate_knowledge_graph` | Entity extraction graph | Backlog |
| `split_document` | Split into sections | Backlog |
| `merge_documents` | Merge multiple documents | Backlog |

---

## SPRINT SEQUENCE

Execute in this order:

| Sprint | Deliverable | Key Files |
|--------|-------------|-----------|
| 1.1 | Project scaffold, Next.js 16, shadcn, Prisma setup | `package.json`, `next.config.ts`, `prisma/schema.prisma` |
| 1.2 | Database setup, Redis connection, session tracking | `lib/db/prisma.ts`, `lib/redis/client.ts` |
| 1.3 | Upload component, file validation, persistent storage | `UploadZone.tsx`, `lib/validation/file.ts`, `/api/upload/route.ts` |
| 1.4 | URL input component | `UrlInput.tsx`, `lib/validation/url.ts` |
| 1.5 | MCP client integration (8 tools), error catalog | `lib/mcp/client.ts`, `lib/mcp/errors.ts`, `/api/process/route.ts` |
| **CHECKPOINT** | **Validate with real MCP server before proceeding** | |
| 1.6 | Results viewer (tabs, renderers, skeleton) | `ResultsViewer.tsx`, `MarkdownView.tsx`, `HtmlView.tsx`, `JsonView.tsx` |
| 1.7 | History view (past jobs, re-download results) | `HistoryView.tsx`, `/api/history/route.ts` |
| 1.8 | Polish, testing, documentation | Tests, README, final validation |

---

## VALIDATION COMMANDS

Run these before marking any sprint complete:

```bash
# TypeScript check
npx tsc --noEmit

# Lint check
npm run lint

# Unit tests
npm run test

# Prisma generate (after schema changes)
npx prisma generate

# Prisma migrate (development)
npx prisma migrate dev

# Build verification (required before Phase 1 complete)
npm run build

# MCP health check
curl http://hx-docling-mcp-server.hx.dev.local:8000/health

# PostgreSQL health check
curl http://hx-postgres-server.hx.dev.local:5432 || echo "Check pg_isready"

# Redis health check
redis-cli -h hx-redis-server.hx.dev.local ping
```

---

## SUCCESS CRITERIA (Phase 1 Complete When)

All of these must be true on hx-cc-server:

- [ ] Application runs at `http://hx-cc-server.hx.dev.local:3000`
- [ ] User can drag-drop PDF and see Markdown output
- [ ] User can drag-drop Excel (.xls, .xlsx) and see output
- [ ] User can drag-drop PowerPoint (.ppt, .pptx) and see output
- [ ] User can paste URL and see HTML output
- [ ] Progress stages display during processing
- [ ] Results viewer shows Markdown/HTML/JSON tabs
- [ ] Download functionality works
- [ ] **Processing results persist to PostgreSQL**
- [ ] **Job history displays past conversions**
- [ ] **User can re-download past results**
- [ ] **Session tracking works via Redis**
- [ ] Error codes display on failures
- [ ] Keyboard shortcuts work
- [ ] Zero TypeScript errors
- [ ] Zero ESLint errors
- [ ] All unit tests pass
- [ ] `npm run build` succeeds
- [ ] No console errors in browser

---

## INFRASTRUCTURE DEPENDENCIES

| Server | IP | Port | Purpose |
|--------|-----|------|---------|
| hx-cc-server | 192.168.10.224 | 3000 | Development server |
| hx-docling-mcp-server | 192.168.10.217 | 8000 | MCP document processing |
| hx-postgres-server | 192.168.10.208 | 5432 | Job & results persistence |
| hx-redis-server | 192.168.10.209 | 6379 | Session tracking |

---

## QUESTIONS? ASK FIRST.

If anything in this instruction file conflicts with the charter, the charter takes precedence. If unclear on scope, ask Agent Zero before implementing.

**Charter Location**: `/home/agent0/HX-Infrastructure/projects/hx-docling-ui/charter.md` (to be placed)

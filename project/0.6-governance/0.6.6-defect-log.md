# Defect Log: hx-docling-application

**Project:** IBM Granite Docling Application
**Purpose:** Track code defects identified during review, implementation, and testing
**Last Updated:** 2025-12-12
**Managed By:** Development Team
**Charter Reference:** hx-docling-ui-charter-v0.7.0.md
**Team Roster Reference:** team-roster-v2.1.0.md

---

## Overview

This log tracks all code defects identified through code review (CodeRabbit, manual review), testing, and production issues. Each defect is assigned to an owner for resolution.

### Severity Definitions

- **CRITICAL**: Blocks functionality, causes crashes, security vulnerability
- **MAJOR**: Significant functionality issue, TypeScript compilation error
- **MINOR**: Code quality issue, best practice violation, accessibility concern
- **TRIVIAL**: Cosmetic issue, documentation error

### Status Definitions

- **OPEN**: Defect identified, not yet assigned
- **ASSIGNED**: Owner assigned, work not started
- **IN_PROGRESS**: Actively being fixed
- **FIXED**: Fix implemented, pending verification
- **VERIFIED**: Fix verified, defect closed
- **WONTFIX**: Intentionally not fixing (documented reason)

---

## Open Defects

*No open defects.*

---

## Fixed Defects (Pending Verification)

### Sprint 1.5b - SSE & Progress Integration (William) - Additional

#### DEF-020: useSSE Hook Options Dependency Causes Unnecessary Reconnects

| Field | Value |
|-------|-------|
| **ID** | DEF-020 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 1600 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The `useSSE` hook's `connect` callback has `[options]` in its dependency array. If callers pass options inline (a new object every render), this causes the hook to disconnect/reconnect on every parent render, degrading performance and user experience.

**Fix Applied:**
Changed dependency array to use individual stable properties instead of the entire options object:
```typescript
}, [options?.jobId, options?.onProgress, options?.onComplete, options?.onError]);
```
This ensures the callback only recreates when actual option values change, not when a new wrapper object is created.

---

### Sprint 1.7 - History View & Persistence (Bob)

#### DEF-019: Inconsistent Error Code Semantics Between Documentation and Implementation

| Field | Value |
|-------|-------|
| **ID** | DEF-019 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.7-history/bob-api-tasks.md` |
| **Line(s)** | 365, 614, 624 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | Bob Martin (`@bob`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
Error code E704 had inconsistent semantics between documentation and implementation:
- Line 614 documents E704 as "Checkpoint expired (TTL exceeded)"
- Line 624 says E703 should handle null checkpoint case
- But line 365 throws E704 when `!job.checkpoint` (no checkpoint exists)

**Fix Applied:**
- Updated implementation at line 365 to throw E703 for missing checkpoint (aligns with E703 being "status not in resumable states OR checkpoint is null")
- E704 remains reserved for checkpoint TTL expiration
- Added explicit TTL check before returning E704
- Implementation now matches validation order: E703 → E704 → E705

---

### Sprint 1.8 - Testing & Documentation (Sri)

#### DEF-018: Redis Health Check Tests Have Placeholder Implementations

| Field | Value |
|-------|-------|
| **ID** | DEF-018 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.8-testing-docs/sri-redis-tasks.md` |
| **Line(s)** | 366-369, 371-374 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | Sri Venkateswaran (`@sri`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
Redis health check tests in the 'Degraded Status' describe block contained placeholder implementations with only comments but no actual mock setup or assertions. This would leave the degraded status code paths untested.

**Fix Applied:**
Replaced placeholder test stubs with complete implementations including mock setup and assertions:
```typescript
it('returns degraded when PING latency exceeds 100ms', async () => {
  jest.spyOn(redis, 'ping').mockImplementation(async () => {
    await new Promise(r => setTimeout(r, 150)); // Simulate 150ms latency
    return 'PONG';
  });
  const health = await checkRedisHealth();
  expect(health.status).toBe('degraded');
  expect(health.details.pingLatency).toBeGreaterThan(100);
});

it('returns degraded when memory usage exceeds 75%', async () => {
  jest.spyOn(redis, 'info').mockResolvedValueOnce(
    'used_memory:8000000000\nmaxmemory:10000000000\n' // 80% usage
  );
  const health = await checkRedisHealth();
  expect(health.status).toBe('degraded');
  expect(health.details.memoryUsagePercent).toBeGreaterThan(75);
});
```

---

### Sprint 1.7 - History View & Persistence (Gordon)

#### DEF-017: JobRow Keyboard Navigation Double-Triggers on Action Buttons

| Field | Value |
|-------|-------|
| **ID** | DEF-017 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.7-history/gordon-shadcn-tasks.md` |
| **Line(s)** | 318-323, 351-353 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | Gordon Zain (`@gordon`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The JobRow component stops propagation for action buttons (`e.stopPropagation()` on lines 351-353), but the TableRow itself has `onKeyDown` that triggers `onClick` for all Enter/Space keys (lines 318-323). If focus is on an action button and user presses Enter, both the button's default behavior and the row's `onClick` will fire.

**Fix Applied:**
Added guard to `onKeyDown` handler to only trigger row click when the event target is the row itself:
```typescript
onKeyDown={(e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    // Don't trigger row click if an interactive element inside the row is focused
    if (e.target === e.currentTarget) {
      e.preventDefault();
      onClick();
    }
  }
}}
```

---

### Sprint 1.5b - SSE & Progress Integration (George)

#### DEF-016: MCPClient AbortController Not Safe for Concurrent invoke() Calls

| Field | Value |
|-------|-------|
| **ID** | DEF-016 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/george-fastmcp-tasks.md` |
| **Line(s)** | 152-175 |
| **Severity** | CRITICAL |
| **Status** | FIXED |
| **Owner** | George Kim (`@george`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The MCPClient stored a single `abortController` field that was overwritten on each `invoke()` call, creating a race condition where concurrent calls would lose cancellation ability.

**Fix Applied:**
- Replaced single `abortController` with `Map<string, AbortController>` keyed by request ID
- Updated `invoke()` to return `{ requestId, result }` for targeted cancellation
- Updated `cancel(requestId)` to accept request ID parameter
- Added `cancelAll()` method for full job cancellation
- Added `hasPendingRequests()` utility method
- Updated `handleCancellation()` to use `cancelAll()`

---

### Sprint 1.4 - URL Input with Security

#### DEF-015: Duplicated SSRF Validation Logic Across Server and Client Layers

| Field | Value |
|-------|-------|
| **ID** | DEF-015 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.4-url-input/bob-api-tasks.md`, `project/0.4-tasks/sprint-1.4-url-input/neo-nextjs-tasks.md` |
| **Line(s)** | bob-api-tasks.md:194-232, neo-nextjs-tasks.md:280-319 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | Bob Martin (`@bob`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
SSRF validation logic was duplicated across Bob's API tasks and Neo's Next.js tasks, with both defining the same localhost, private IP, and internal domain blocking patterns independently.

**Fix Applied:**
- Created new task BOB-1.4-005 for shared SSRF config (`src/lib/validation/ssrf-config.ts`)
- Updated BOB-1.4-003 to import from shared config
- Updated NEO-1.4-002 to import from shared config, removed duplicate definitions
- Added cross-team dependency (NEO-1.4-002 depends on BOB-1.4-005)

---

### Sprint 0 - Prerequisites

#### DEF-014: Connection String Pool Settings Inconsistent with Environment Variables

| Field | Value |
|-------|-------|
| **ID** | DEF-014 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-0-prerequisites/trinity-postgresql-tasks.md` |
| **Line(s)** | 245, 251-252 |
| **Severity** | MINOR |
| **Status** | FIXED |
| **Owner** | Trinity (`@trinity`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
Connection string templates had inconsistent configuration approach. DATABASE_URL hardcoded `connection_limit=5&pool_timeout=20` while separate environment variables `DB_POOL_SIZE` and `DB_POOL_TIMEOUT_MS` suggested configurability. Also had unit mismatch (seconds vs milliseconds).

**Fix Applied:**
- DATABASE_URL now uses `${DB_POOL_SIZE}` and `${DB_POOL_TIMEOUT_SEC}` variables
- Renamed `DB_POOL_TIMEOUT_MS` to `DB_POOL_TIMEOUT_SEC` (seconds to match PostgreSQL)
- Added clarifying comments explaining variable relationship

---

### Specification - Core Documents

#### DEF-013: Retry Attempt Count Mismatch Between Code and State Machine

| Field | Value |
|-------|-------|
| **ID** | DEF-013 |
| **Source** | CodeRabbit |
| **File** | `project/0.3-specification/0.3.1-detailed-specification.md` |
| **Line(s)** | 677, 683-688, 708-730 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | Alex Rivera (`@platform-architect`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
Retry attempt count mismatch between code implementation and state machine specification. The `maxAttempts: 3` config with `for (attempt = 0; attempt < 3)` loop gave only 3 total attempts, but the state machine shows PROCESSING + RETRY_1 + RETRY_2 + RETRY_3 = 4 total attempts.

**Fix Applied:**
Restructured to two-phase approach using `maxRetries: 3`:
- Phase 1: Initial attempt in PROCESSING state
- Phase 2: Retry loop for RETRY_1, RETRY_2, RETRY_3 states
- All 3 backoff values [1000, 2000, 4000] now correctly used
- Changed `maxAttempts` to `maxRetries` in retry event schema

---

### Sprint 1.5a - MCP Client Integration

#### DEF-011: Error Code Mapping Inconsistency Between Catalog and JSON-RPC Mapping

| Field | Value |
|-------|-------|
| **ID** | DEF-011 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5a-mcp-client/james-mcp-tasks.md` |
| **Line(s)** | 278-284, 308-314 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | James Chen (`@james`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
Error code mapping inconsistency between error code ranges and application codes. E2xx codes were used for both JSON-RPC protocol errors and MCP runtime errors, causing conflicts.

**Fix Applied:**
Separated error codes into non-overlapping ranges:
- **E2xx (E200-E204)**: JSON-RPC protocol errors (parse, invalid request, method not found, invalid params, internal)
- **E3xx (E301-E305)**: MCP runtime errors (not initialized, server unavailable, timeout, unknown tool, missing capability)

---

#### DEF-012: MCP Initialization Missing Protocol Enforcement Guard

| Field | Value |
|-------|-------|
| **ID** | DEF-012 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5a-mcp-client/james-mcp-tasks.md` |
| **Line(s)** | 110-112, 152-159 |
| **Severity** | CRITICAL |
| **Status** | FIXED |
| **Owner** | James Chen (`@james`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The 3-step MCP initialization lacked explicit protocol enforcement guard to prevent tool calls before `notifications/initialized` completes.

**Fix Applied:**
Added explicit guard requirements:
- `initialized` flag set to true ONLY after Step 3 (notifications/initialized) completes
- Guard in `invoke()` method throws E301 error if `initialized` is false
- Code example added to technical notes

---

### Sprint 1.3 - Upload Components

#### DEF-010: Zod Schema Field Type Mismatch with onRemove Behavior

| Field | Value |
|-------|-------|
| **ID** | DEF-010 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.3-upload/ola-frontend-tasks.md` |
| **Line(s)** | 466-470, 555 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | Ola Okonkwo (`@ola`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The Zod schema at lines 466-470 requires a `File` instance via `z.instanceof(File)` with a refinement checking for null. However, the `onRemove` callback at line 555 calls `field.onChange(null)`, which would violate the schema and cause validation errors when the user removes a selected file.

**Fix Applied:**
Added `.nullable()` to the schema to allow null values during the form lifecycle:
```typescript
const uploadSchema = z.object({
  file: z
    .instanceof(File)
    .nullable()
    .refine((file) => file !== null, 'Please select a file'),
})
```

---

### Sprint 1.5b - SSE & Progress Integration

#### DEF-001: Missing Progress Interface Definition

| Field | Value |
|-------|-------|
| **ID** | DEF-001 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 281, 309 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The `Progress` type is referenced in the `PollingFallback` constructor and callback but is never defined. This will cause TypeScript compilation errors across `useSSE`, `useProcess`, and `PollingFallback`.

**Fix Required:**
Define the `Progress` interface in a shared types module:

```typescript
// src/types/progress.ts
export interface Progress {
  status: 'PENDING' | 'PROCESSING' | 'COMPLETED' | 'FAILED';
  progress: number;       // 0-100
  stage: string;
  currentStage?: string;
  message?: string;
}
```

---

#### DEF-002: Missing AppError Class Definition

| Field | Value |
|-------|-------|
| **ID** | DEF-002 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 1445, 1463, 1494 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The `useProcess` hook uses `AppError` without defining or importing it. This will cause TypeScript compilation errors.

**Fix Required:**
Define the `AppError` class in a shared types module:

```typescript
// src/types/errors.ts
export class AppError extends Error {
  constructor(
    public code: string,
    public statusCode: number,
    message: string
  ) {
    super(message);
    this.name = 'AppError';
  }
}
```

---

#### DEF-003: Missing ProcessResult Interface Definition

| Field | Value |
|-------|-------|
| **ID** | DEF-003 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 1444 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The `ProcessResult` type is referenced in `useProcess` but never defined. This will cause TypeScript compilation errors.

**Fix Required:**
Define the `ProcessResult` interface in a shared types module:

```typescript
// src/types/process.ts
export interface ProcessResult {
  jobId: string;
  status: 'COMPLETED' | 'FAILED';
  markdown?: string;
  html?: string;
  json?: string;
  error?: string;
  completedAt: number;
}
```

---

#### DEF-004: Missing subscribeToJobUpdates Function

| Field | Value |
|-------|-------|
| **ID** | DEF-004 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 682 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
Line 682 calls `subscribeToJobUpdates(jobId, ...)`, but this function is not imported or defined. This will cause a runtime error.

**Fix Required:**
Define the function implementation:

```typescript
// src/lib/sse/job-updates.ts
import { redis } from '@/lib/redis/client';

interface JobUpdate {
  event: string;
  data: unknown;
  eventId: number;
}

export function subscribeToJobUpdates(
  jobId: string,
  callback: (update: JobUpdate) => void
): () => void {
  // Redis Pub/Sub or polling-based job update listener
  const channel = `job:${jobId}:updates`;

  const unsubscribe = redis.psubscribe(channel, (message) => {
    try {
      const update = JSON.parse(message);
      callback(update);
    } catch (error) {
      console.error('Failed to parse job update:', error);
    }
  });

  return () => unsubscribe();
}
```

---

#### DEF-005: PollingFallback Missing Error Handling and Timeout

| Field | Value |
|-------|-------|
| **ID** | DEF-005 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 306-320 |
| **Severity** | MAJOR |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The polling loop lacks try-catch around `response.json()` and timeout safeguards on the fetch. A malformed response or indefinitely hanging fetch could leave the polling timer active.

**Fix Required:**
Add timeout and handle JSON parsing errors:

```typescript
start(): void {
  const startTime = Date.now();

  const poll = async () => {
    if (Date.now() - startTime > this.config.maxPollDuration) {
      this.stop();
      return;
    }

    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 5000); // 5s timeout

      const response = await fetch(`/api/v1/jobs/${this.jobId}/status`, {
        signal: controller.signal,
      });
      clearTimeout(timeout);

      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const progress = await response.json();
      this.onProgress(progress);

      if (progress.status === 'COMPLETED' || progress.status === 'FAILED') {
        this.stop();
        return;
      }
    } catch (error) {
      if (error instanceof DOMException && error.name === 'AbortError') {
        console.warn('Polling request timeout');
      } else {
        console.error('Polling error:', error);
      }
    }

    this.pollingTimer = setTimeout(poll, this.config.interval);
  };

  poll();
}
```

---

#### DEF-006: EventSource lastEventId Incorrect Usage

| Field | Value |
|-------|-------|
| **ID** | DEF-006 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 1358 |
| **Severity** | CRITICAL |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The code attempts to read `e.lastEventId` from EventSource events, but the EventSource API does not populate `lastEventId` on individual events. The browser automatically handles `Last-Event-ID` reconnection if the server sends event IDs.

**Fix Required:**
Remove manual `lastEventId` tracking and rely on browser-native EventSource reconnection:

```typescript
es.addEventListener('progress', (e) => {
  // Browser automatically tracks Last-Event-ID for reconnection
  onProgress(JSON.parse(e.data));
});

es.addEventListener('sync', (e) => {
  // Sync events can include state after reconnection
  onProgress(JSON.parse(e.data));
});
```

If manual Last-Event-ID tracking is required, store it server-side and send it explicitly in a sync event after reconnection.

---

#### DEF-007: LoadingState Missing prefers-reduced-motion Support

| Field | Value |
|-------|-------|
| **ID** | DEF-007 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 1173 |
| **Severity** | MINOR |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
`LoadingState` component uses `animate-pulse` for stage variant but should respect `prefers-reduced-motion`. This can cause accessibility issues for users with motion sensitivity.

**Fix Required:**
Use the `cn` utility to conditionally apply the animation class with `motion-safe:` prefix:

```typescript
export function LoadingState({ variant, stage, className }: LoadingStateProps) {
  if (variant === 'stage') {
    const StageIcon = getStageIcon(stage);
    return (
      <div className={cn('flex items-center gap-2', className)}>
        <StageIcon
          className={cn(
            'h-5 w-5 text-primary',
            'motion-safe:animate-pulse'
          )}
        />
        <span className="text-sm text-muted-foreground">
          {getStageLabel(stage)}
        </span>
      </div>
    );
  }
  // ... other variants
}
```

---

#### DEF-008: useSSE Hook Integration Issues

| Field | Value |
|-------|-------|
| **ID** | DEF-008 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 1330-1398 |
| **Severity** | CRITICAL |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
The `useSSE` hook has multiple integration issues:
1. Assumes `lastEventId` can be extracted from EventSource events (incorrect - see DEF-006)
2. Called from `useProcess` but `useProcess` does not pass the `jobId` until after the job is created asynchronously, leading to a timing issue
3. Does not handle the `X-Session-Id` header, which is required by the SSE endpoint (line 657)
4. Connection logic creates a new EventSource on every render without guard against duplicate connections

**Fix Required:**
Refactor `useProcess` to pass `jobId` and session context to `useSSE` once available, and add connection guard:

```typescript
export function useSSE({
  jobId,
  onProgress,
  onComplete,
  onError,
}: UseSSEOptions): UseSSEReturn {
  const [isConnected, setIsConnected] = useState(false);
  const [isReconnecting, setIsReconnecting] = useState(false);
  const [usePolling, setUsePolling] = useState(false);
  const eventSourceRef = useRef<EventSource | null>(null);
  const connectingRef = useRef(false); // Guard against duplicate connections
  const reconnectManager = useRef(new ReconnectionManager());

  const connect = useCallback(() => {
    // Prevent duplicate connection attempts
    if (connectingRef.current || eventSourceRef.current?.readyState === EventSource.OPEN) {
      return;
    }
    connectingRef.current = true;

    const url = new URL(`/api/v1/process/${jobId}/events`, window.location.origin);

    const es = new EventSource(url.toString());

    es.onopen = () => {
      connectingRef.current = false;
      setIsConnected(true);
      setIsReconnecting(false);
      reconnectManager.current.reset();
    };

    es.addEventListener('progress', (e) => {
      onProgress(JSON.parse(e.data));
    });

    es.addEventListener('complete', () => {
      onComplete();
      es.close();
    });

    es.onerror = () => {
      connectingRef.current = false;
      setIsConnected(false);
      es.close();

      const delay = reconnectManager.current.getNextDelay();
      if (delay !== null) {
        setIsReconnecting(true);
        setTimeout(connect, delay);
      } else {
        setUsePolling(true);
      }
    };

    eventSourceRef.current = es;
  }, [jobId, onProgress, onComplete]);

  useEffect(() => {
    if (!jobId) return; // Only connect if jobId is provided
    connect();
    return () => {
      eventSourceRef.current?.close();
    };
  }, [jobId, connect]);

  return {
    isConnected,
    isReconnecting,
    retryCount: reconnectManager.current.getRetryCount(),
    usePolling,
    disconnect: () => eventSourceRef.current?.close(),
  };
}
```

---

#### DEF-009: useProcess Hook Missing useSSE Integration

| Field | Value |
|-------|-------|
| **ID** | DEF-009 |
| **Source** | CodeRabbit |
| **File** | `project/0.4-tasks/sprint-1.5b-sse-progress/william-infrastructure-tasks.md` |
| **Line(s)** | 1458-1521 |
| **Severity** | CRITICAL |
| **Status** | FIXED |
| **Owner** | William Chen (`@william`) |
| **Reported** | 2025-12-12 |
| **Fixed** | 2025-12-12 |

**Description:**
After the job is created and `jobId` is set (line 1486), the hook should initiate the `useSSE` hook with proper callbacks. Currently, the hook structure does not call `useSSE` at all.

**Fix Required:**
Refactor to conditionally call `useSSE` after `jobId` is available:

```typescript
export function useProcess({ onComplete, onError }: UseProcessOptions): UseProcessReturn {
  const [isProcessing, setIsProcessing] = useState(false);
  const [isCancelling, setIsCancelling] = useState(false);
  const [progress, setProgress] = useState(0);
  const [stage, setStage] = useState('');
  const [error, setError] = useState<AppError | null>(null);
  const [jobId, setJobId] = useState<string | null>(null);

  const interpolator = useRef<ProgressInterpolator | null>(null);

  // Conditionally call useSSE only when jobId is set
  const sse = useSSE(
    jobId
      ? {
          jobId,
          onProgress: (data) => {
            setStage(data.stage || '');
            if (interpolator.current) {
              interpolator.current.setActualProgress(data.progress);
            }
          },
          onComplete: () => {
            if (interpolator.current) {
              interpolator.current.complete();
            }
            setIsProcessing(false);
            onComplete({
              jobId: jobId!,
              status: 'COMPLETED',
              completedAt: Date.now(),
            });
          },
          onError,
        }
      : null
  );

  // ... rest of implementation
}
```

---

## Defect Summary

| Severity | Open | Fixed | Verified | Total |
|----------|------|-------|----------|-------|
| CRITICAL | 0 | 5 | 0 | 5 |
| MAJOR | 0 | 13 | 0 | 13 |
| MINOR | 0 | 2 | 0 | 2 |
| TRIVIAL | 0 | 0 | 0 | 0 |
| **Total** | **0** | **20** | **0** | **20** |

---

## Defect by Owner

| Owner | Open | In Progress | Fixed | Total |
|-------|------|-------------|-------|-------|
| William Chen (`@william`) | 0 | 0 | 10 | 10 |
| Ola Okonkwo (`@ola`) | 0 | 0 | 1 | 1 |
| James Chen (`@james`) | 0 | 0 | 2 | 2 |
| Alex Rivera (`@platform-architect`) | 0 | 0 | 1 | 1 |
| Trinity (`@trinity`) | 0 | 0 | 1 | 1 |
| Bob Martin (`@bob`) | 0 | 0 | 2 | 2 |
| George Kim (`@george`) | 0 | 0 | 1 | 1 |
| Gordon Zain (`@gordon`) | 0 | 0 | 1 | 1 |
| Sri Venkateswaran (`@sri`) | 0 | 0 | 1 | 1 |
| **Total** | **0** | **0** | **20** | **20** |

---

## Closed Defects

*No defects closed yet. 20 defects fixed pending verification.*

---

## Recent Updates

| Date | Change | Reference |
|------|--------|-----------|
| 2025-12-12 | Created defect log with 9 CodeRabbit defects from Sprint 1.5b | CodeRabbit review |
| 2025-12-12 | William Chen fixed all 9 defects, task file updated to v1.1.0 | william-infrastructure-tasks.md v1.1.0 |
| 2025-12-12 | Added DEF-010 (Zod schema mismatch) from Sprint 1.3, assigned to Ola Okonkwo | CodeRabbit review |
| 2025-12-12 | Ola Okonkwo fixed DEF-010, task file updated to v1.0.1 | ola-frontend-tasks.md v1.0.1 |
| 2025-12-12 | Added DEF-011 (error code mapping inconsistency), DEF-012 (MCP init guard), assigned to James Chen | CodeRabbit review |
| 2025-12-12 | James Chen fixed DEF-011 and DEF-012, task file updated to v1.1.0 | james-mcp-tasks.md v1.1.0 |
| 2025-12-12 | Added DEF-013 (retry count mismatch in specification), assigned to Alex Rivera | CodeRabbit review |
| 2025-12-12 | Alex Rivera fixed DEF-013, specification updated to v1.2.1 | 0.3.1-detailed-specification.md v1.2.1 |
| 2025-12-12 | Added DEF-014 (connection string pool settings inconsistency), assigned to Trinity | CodeRabbit review |
| 2025-12-12 | Trinity fixed DEF-014, task file updated to v1.1.0 | trinity-postgresql-tasks.md v1.1.0 |
| 2025-12-12 | Added DEF-015 (duplicated SSRF validation logic), assigned to Bob Martin | CodeRabbit review |
| 2025-12-12 | Bob Martin fixed DEF-015, created shared SSRF config, updated both task files to v1.1.0 | bob-api-tasks.md v1.1.0, neo-nextjs-tasks.md v1.1.0 |
| 2025-12-12 | Added DEF-016 (MCPClient AbortController concurrency issue), assigned to George Kim | CodeRabbit review |
| 2025-12-12 | George Kim fixed DEF-016, task file updated to v1.1.0 | george-fastmcp-tasks.md v1.1.0 |
| 2025-12-12 | Added DEF-017 (JobRow keyboard navigation double-trigger), assigned to Gordon Zain | CodeRabbit review |
| 2025-12-12 | Gordon Zain fixed DEF-017, task file updated to v1.0.1 | gordon-shadcn-tasks.md v1.0.1 |
| 2025-12-12 | Added DEF-018 (Redis health check placeholder tests), assigned to Sri Venkateswaran | CodeRabbit review |
| 2025-12-12 | Sri Venkateswaran fixed DEF-018, task file updated to v1.0.1 | sri-redis-tasks.md v1.0.1 |
| 2025-12-12 | Added DEF-019 (inconsistent error code semantics E704/E703), assigned to Bob Martin | CodeRabbit review |
| 2025-12-12 | Bob Martin fixed DEF-019, task file updated to v1.0.1 | bob-api-tasks.md v1.0.1 |
| 2025-12-12 | Added DEF-020 (useSSE options dependency causes unnecessary reconnects), assigned to William Chen | CodeRabbit review |
| 2025-12-12 | William Chen fixed DEF-020, task file updated to v1.2.0 | william-infrastructure-tasks.md v1.2.0 |

---

**Last Updated By:** Agent Zero
**Last Updated:** 2025-12-12
